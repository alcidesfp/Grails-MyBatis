<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
    <head>
        <title>Grails MyBatis Plugin 0.0.1</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />
        <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8" />
    <script type="text/javascript">
function addJsClass(el) {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
    </head>

    <body class="body" onload="addJsClass();">
        <div id="navigation">
            <ul>
                <li>
                    <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                        <a href="../guide/index.html" class="button">Table of contents</a>
                        <div id="nav-summary-childs" style="display:none;">
                            
                            <div class="toc-item" style="margin-left:0"><a href="#1%20Introduciton%20to%20Grails%20MyBatis%20Plugin"><strong>1</strong><span>Introduciton to Grails MyBatis Plugin</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#2%20Getting%20started"><strong>2</strong><span>Getting started</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#3%20Working%20with%20MyBatis"><strong>3</strong><span>Working with MyBatis</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#4%20Optimistic%20locking"><strong>4</strong><span>Optimistic locking</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#5%20Multivendor%20database%20support"><strong>5</strong><span>Multivendor database support</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#6%20Custom%20TypeHandlers"><strong>6</strong><span>Custom TypeHandlers</span></a></div>
                            
                        </div>
                    </div>
                </li>
                <li class="separator selected">
                    <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
                </li>
            </ul>
        </div>
        <div id="header">
            <div class="images clearfix">
                
                
            </div>
            <p>The MyBatis plugin enables Grails integration with MyBatis ORM framework
</p>
        </div>


        <table id="colset" border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td id="col1">
                    <div id="main" class="corner-all">

                        <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                        <div class="project">
                            <h1>Grails MyBatis Plugin - Reference Documentation</h1>
                            <p><strong>Authors:</strong> Franjo Žilić</p>
                            <p><strong>Version:</strong> 0.0.1</p>
                            
                        </div>

                        
                        <div id="table-of-content">
                            <h2>Table of Contents</h2>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#1%20Introduciton%20to%20Grails%20MyBatis%20Plugin"><strong>1</strong><span>Introduciton to Grails MyBatis Plugin</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#2%20Getting%20started"><strong>2</strong><span>Getting started</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#3%20Working%20with%20MyBatis"><strong>3</strong><span>Working with MyBatis</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#4%20Optimistic%20locking"><strong>4</strong><span>Optimistic locking</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#5%20Multivendor%20database%20support"><strong>5</strong><span>Multivendor database support</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#6%20Custom%20TypeHandlers"><strong>6</strong><span>Custom TypeHandlers</span></a></div>
                            
                            <div style="clear:both" ></div>
                        </div>
                        
                        

<h1 id="1 Introduciton to Grails MyBatis Plugin">1 Introduciton to Grails MyBatis Plugin</h1>
The MyBatis plugin enables Grails integration with <a href="http://code.google.com/p/mybatis/" target="blank">MyBatis</a> ORM framework. Work on this plugin has been inspired by original <a href="http://grails.org/plugin/ibatis" target="blank">iBatis</a> plugin written by brian.j.sanders.<p class="paragraph"/>While writing this plugin basic working principles have been kept, but most of the code had been rewritten. Migration from original plugin to this one is still not documented and support, although it should be possible.<p class="paragraph"/><h1>Changes from original plugin</h1>
<ul class="star">
<li>Upgrade to Grails 2.0.3</li>
<ul class="star">
<li>Grails 1.x is not supported, and some features require Grails 2.0.3 or higher</li>
</ul>
<li>Removal of deprecated Grails references</li>
<li>Package name changes</li>
<li>Upgrade to MyBatis 3.1.1 library</li>
</ul><p class="paragraph"/><h1>Features</h1>
<ul class="star">
<li>Dynamic mapping of MyBatis queries to methods</li>
<li>Multiple datasource support</li>
<li>Optimistic locking support</li>
<li>Multivendor database support</li>
</ul><p class="paragraph"/>


<h1 id="2 Getting started">2 Getting started</h1>
<h1>Installation</h1>
Add plugin dependency to BuildConfig.groovy
<div class="code"><pre>compile &#34;:mybatis:0.0.1&#34;</pre></div><p class="paragraph"/><h1>UnInstall</h1>
Remove plugin dependency from BuildConfig.groovy and remove directories grails-app/gateways and grails-app/typeHandlers<p class="paragraph"/><h2>Workspace configuration</h2>
If you are using SpringSource Tool Suite or IntelliJ Idea as your IDE you should add grails-app/gateways and grails-app/typeHandlers to your source path for class resolution.<p class="paragraph"/><h1>Configuration</h1>
None of configuration options is required for starting application with this plugin, but you should modify them to suite your own application
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>Option</th><th>Description</th></tr><tr class="table-odd"><td>mybatis.dataSourceNames</td><td>List of datasource names used for MyBatis</td></tr><tr class="table-even"><td>mybatis.optimisticLocking</td><td>Enable OptimisticLockingInterceptor globally</td></tr><tr class="table-odd"><td>mybatis.multivendor.enabled</td><td>Enable support for multiple database engines</td></tr><tr class="table-even"><td>mybatis.multivendor.mapping</td><td>Map multiple database engines to specific MyBatis database ids</td></tr></table><p class="paragraph"/><h2>DataSource configuration</h2>
To support multiple datasources you have to configure which ones are going to be used by MyBatis plugin.<p class="paragraph"/>By default plugin uses only default datasource and each gateway artefact is registered to default datasource. If you wish to use more then one datasource add their names to this list.<p class="paragraph"/><div class="code"><pre>mybatis.dataSourceNames = &#91;'dataSource'&#93;</pre></div><p class="paragraph"/><h2>Optimistic locking configuration</h2>
Optimistic locking is enabled by default on all datasources but no object will be versioned unless they are configured with a static field. To change optimistic locking functionality add this to your configuration.<p class="paragraph"/><div class="code"><pre>mybatis.optimisticLocking = <span class="java&#45;keyword">false</span></pre></div><p class="paragraph"/><h2>Multivendor database support</h2>
If you wish to support more then one database vendor you have to enable support in plugin configuration and map different database names to a specific databaseId key. For more information about multivendor support in MyBatis consult <a href="http://www.mybatis.org/core/configuration.html#databaseIdProvider" target="blank">MyBatis documentation</a>. Sample configuration and use is provided in this documentation.<p class="paragraph"/><div class="code"><pre>mybatis.multivendor.enabled = <span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/><blockquote class="note">
If you choose to implement multivendor support you have to map database names to distinct ids. This is a sample configuration which provides mapping for couple of database names
<div class="code"><pre>mybatis.multivendor.mapping = &#91;
    'Microsoft SQL Server': 'mssql',
    'H2': 'h2',
    'Informix Dynamic Server': 'informix',
    'DB2/LINUXX8664': 'db2',
    'DB2/400 SQL': 'db2'
&#93;</pre></div>
</blockquote>



<h1 id="3 Working with MyBatis">3 Working with MyBatis</h1>
<h1>Basic object mapping and support files</h1><p class="paragraph"/>When working with MyBatis plugin your "Domain" classes should be located in src/groovy and not in grails-app/domain. This is necessary to avoid conflict with GROM since MyBatis plugin can coexist with existing GORM Domain classes.<p class="paragraph"/>To start, create a simple class called Person in package org.grails.mybatis.example<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.grails.mybatis.example<p class="paragraph"/>class Person &#123;
  <span class="java&#45;object">String</span> firstName
  <span class="java&#45;object">String</span> lastName
  <span class="java&#45;object">Integer</span> age
&#125;</pre></div><p class="paragraph"/>We need to create a placeholder artefact class for our integration with MyBatis, so create a class SampleGateway in src/gateways/org/grails/mybatis/example.<p class="paragraph"/><blockquote class="note">
SampleGateway is an artefact class, and each MyBatis gateway should end with "Gateway" for artefact resolution.
</blockquote><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.grails.mybatis.example<p class="paragraph"/>class PersonGateway &#123;<p class="paragraph"/>&#125;</pre></div><p class="paragraph"/>MyBatis mapper XML should be created in same directory as Gateway class.<p class="paragraph"/><blockquote class="note">
Plugin is CamelCase sensitive. CamelCase Gateways should have their mapper files named using - notation.
CamelCaseGateway.groovy will have camel-case.xml mapper file matched to it.
</blockquote><p class="paragraph"/>MyBatis mapper files are standard and you should consult <a href="http://www.mybatis.org/core/" target="blank">MyBatis documentation</a> for more details.<p class="paragraph"/><blockquote class="note">
If a select query id ends with "List" it will be treated as an MyBatis ListOp and it is expected to return a list of results.
If you omit "List" from the end of select id then that select query should return just one result. This behavior can be overridden using "forceAsListOps" static field in matching Gateway artefact.
</blockquote><p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;?xml version=<span class="xml&#45;quote">"1.0"</span> encoding=<span class="xml&#45;quote">"UTF&#45;8"</span> ?&#62;</span>
&#60;!DOCTYPE mapper PUBLIC <span class="xml&#45;quote">"&#45;//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="xml&#45;quote">"http://mybatis.org/dtd/mybatis&#45;3&#45;mapper.dtd"</span>&#62;
<span class="xml&#45;tag">&#60;mapper namespace=<span class="xml&#45;quote">"org.grails.mybatis.example.person"</span>&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;/mapper&#62;</span></pre></div><p class="paragraph"/>For testing purposes create a Integration test SampleGatewayTests in test/integration.<p class="paragraph"/><blockquote class="note">
MyBatis plugin interacts with real databases so all tests for database operation should be integration tests.
</blockquote><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.grails.mybatis.example
<span class="java&#45;keyword">import</span> groovy.sql.Sql<p class="paragraph"/>class PersonGatewayTests <span class="java&#45;keyword">extends</span> GroovyTestCase &#123;<p class="paragraph"/>  /&#42;&#42;
   &#42; Dependency injection is used to test Gateway artefacts
   &#42;/
  def dataSource
  def personGateway<p class="paragraph"/>  <span class="java&#45;keyword">protected</span> void setUp() <span class="java&#45;keyword">throws</span> Exception &#123;
    def sql = <span class="java&#45;keyword">new</span> Sql(dataSource)
    sql.execute(<span class="java&#45;quote">""</span><span class="java&#45;quote">"CREATE TABLE PERSON (
    FIRST_NAME VARCHAR(30),
    LAST_NAME VARCHAR(30),
    AGE INTEGER
    )"</span><span class="java&#45;quote">""</span>)
    sql.execute(<span class="java&#45;quote">""</span><span class="java&#45;quote">"INSERT INTO PERSON (FIRST_NAME, LAST_NAME, AGE) VALUES ('John', 'Doe', 20)"</span><span class="java&#45;quote">""</span>)
    sql.execute(<span class="java&#45;quote">""</span><span class="java&#45;quote">"INSERT INTO PERSON (FIRST_NAME, LAST_NAME, AGE) VALUES ('Mark', 'Miles', 23)"</span><span class="java&#45;quote">""</span>)
  &#125;<p class="paragraph"/>  <span class="java&#45;keyword">protected</span> void tearDown() <span class="java&#45;keyword">throws</span> Exception &#123;
    def sql = <span class="java&#45;keyword">new</span> Sql(dataSource)
    sql.execute(<span class="java&#45;quote">""</span><span class="java&#45;quote">"DROP TABLE IF EXISTS PERSON"</span><span class="java&#45;quote">""</span>)
  &#125;<p class="paragraph"/>  void testDependencies() &#123;
    assert dataSource
    assert personGateway
  &#125;<p class="paragraph"/>  void testLoadAllPersonList() &#123;
    def results = personGateway.loadAllPersonList()<p class="paragraph"/>    assert results
    assert results.size() == 2
    assert results&#91;0&#93; <span class="java&#45;keyword">instanceof</span> Person
    assert results&#91;0&#93;.firstName == 'John'
    assert results&#91;1&#93;.firstName == 'Mark'
  &#125;<p class="paragraph"/>  void testLoadPersonByName() &#123;
    def result = personGateway.loadPersonByName('John')<p class="paragraph"/>    assert result
    assert result <span class="java&#45;keyword">instanceof</span> Person
    assert result.lastName == 'Doe'
    assert result.age == 20<p class="paragraph"/>    result = personGateway.loadPersonByName('Mark')<p class="paragraph"/>    assert result
    assert result <span class="java&#45;keyword">instanceof</span> Person
    assert result.lastName == 'Miles'
    assert result.age == 23<p class="paragraph"/>    result = personGateway.loadPersonByName('something')<p class="paragraph"/>    assert !result
  &#125;
&#125;</pre></div><p class="paragraph"/>In order to support our tests add following MyBatis queries and mappings to sample.xml mapper<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;?xml version=<span class="xml&#45;quote">"1.0"</span> encoding=<span class="xml&#45;quote">"UTF&#45;8"</span> ?&#62;</span>
&#60;!DOCTYPE mapper PUBLIC <span class="xml&#45;quote">"&#45;//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="xml&#45;quote">"http://mybatis.org/dtd/mybatis&#45;3&#45;mapper.dtd"</span>&#62;
<span class="xml&#45;tag">&#60;mapper namespace=<span class="xml&#45;quote">"org.grails.mybatis.example.person"</span>&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;select id=<span class="xml&#45;quote">"loadAllPersonList"</span> resultMap=<span class="xml&#45;quote">"basicPersonMap"</span>&#62;</span>
    SELECT &#42; FROM PERSON
  <span class="xml&#45;tag">&#60;/select&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;select id=<span class="xml&#45;quote">"loadPersonByName"</span> resultMap=<span class="xml&#45;quote">"basicPersonMap"</span>&#62;</span>
    SELECT &#42; FROM PERSON WHERE FIRST_NAME = &#35;&#123;value&#125;
  <span class="xml&#45;tag">&#60;/select&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;resultMap type=<span class="xml&#45;quote">"org.grails.mybatis.example.Person"</span> id=<span class="xml&#45;quote">"basicPersonMap"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;result property=<span class="xml&#45;quote">"firstName"</span> column=<span class="xml&#45;quote">"FIRST_NAME"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;result property=<span class="xml&#45;quote">"lastName"</span> column=<span class="xml&#45;quote">"LAST_NAME"</span>/&#62;</span>
    <span class="xml&#45;tag">&#60;result property=<span class="xml&#45;quote">"age"</span> column=<span class="xml&#45;quote">"AGE"</span>/&#62;</span>
  <span class="xml&#45;tag">&#60;/resultMap&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;/mapper&#62;</span></pre></div><p class="paragraph"/>Working with insert, update and delete queries is similar to select queries and you should consult MyBatis documentation for more information.



<h1 id="4 Optimistic locking">4 Optimistic locking</h1>
<h1>Optimistic locking</h1><p class="paragraph"/>Optimistic locking in this plugin is based on Hibernate optimistic locking idea.<p class="paragraph"/>To enable optimistic locking for our Person class we have to add id and version properties and static that enables optimistic locking for this class.<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.grails.mybatis.example<p class="paragraph"/>class Person &#123;
  def <span class="java&#45;keyword">static</span> useOptimisticLocking = <span class="java&#45;keyword">true</span><p class="paragraph"/>  <span class="java&#45;object">Integer</span> id
  <span class="java&#45;object">Integer</span> version
  <span class="java&#45;object">String</span> firstName
  <span class="java&#45;object">String</span> lastName
  <span class="java&#45;object">Integer</span> age
&#125;</pre></div><p class="paragraph"/>We have to modify our mapping xml to support optimistic locking and new properties.
Simply querying for object version is not enough so we should also add an insert and update query.<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;?xml version=<span class="xml&#45;quote">"1.0"</span> encoding=<span class="xml&#45;quote">"UTF&#45;8"</span> ?&#62;</span>
&#60;!DOCTYPE mapper PUBLIC <span class="xml&#45;quote">"&#45;//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="xml&#45;quote">"http://mybatis.org/dtd/mybatis&#45;3&#45;mapper.dtd"</span>&#62;
<span class="xml&#45;tag">&#60;mapper namespace=<span class="xml&#45;quote">"org.grails.mybatis.example.person"</span>&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;select id=<span class="xml&#45;quote">"loadCurrentVersionOfPersonById"</span> resultType=<span class="xml&#45;quote">"integer"</span> parameterType=<span class="xml&#45;quote">"integer"</span>&#62;</span>
    SELECT VERSION
    FROM PERSON
    WHERE ID = &#35;&#123;value&#125;
  <span class="xml&#45;tag">&#60;/select&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;select id=<span class="xml&#45;quote">"loadAllPersonList"</span> resultMap=<span class="xml&#45;quote">"basicPersonMap"</span>&#62;</span>
    SELECT &#42; FROM PERSON
  <span class="xml&#45;tag">&#60;/select&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;select id=<span class="xml&#45;quote">"loadPersonById"</span> resultMap=<span class="xml&#45;quote">"basicPersonMap"</span>&#62;</span>
    SELECT &#42; FROM PERSON WHERE ID = &#35;&#123;value&#125;
  <span class="xml&#45;tag">&#60;/select&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;resultMap type=<span class="xml&#45;quote">"org.grails.mybatis.example.Person"</span> id=<span class="xml&#45;quote">"basicPersonMap"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;id property=<span class="xml&#45;quote">"id"</span> column=<span class="xml&#45;quote">"ID"</span> javaType=<span class="xml&#45;quote">"Integer"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;result property=<span class="xml&#45;quote">"version"</span> column=<span class="xml&#45;quote">"VERSION"</span> javaType=<span class="xml&#45;quote">"Integer"</span>/&#62;</span>
    <span class="xml&#45;tag">&#60;result property=<span class="xml&#45;quote">"firstName"</span> column=<span class="xml&#45;quote">"FIRST_NAME"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;result property=<span class="xml&#45;quote">"lastName"</span> column=<span class="xml&#45;quote">"LAST_NAME"</span>/&#62;</span>
    <span class="xml&#45;tag">&#60;result property=<span class="xml&#45;quote">"age"</span> column=<span class="xml&#45;quote">"AGE"</span>/&#62;</span>
  <span class="xml&#45;tag">&#60;/resultMap&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;insert id=<span class="xml&#45;quote">"insertPerson"</span> parameterType=<span class="xml&#45;quote">"org.grails.mybatis.example.Person"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;selectKey keyProperty=<span class="xml&#45;quote">"id"</span> resultType=<span class="xml&#45;quote">"integer"</span> order=<span class="xml&#45;quote">"BEFORE"</span>&#62;</span>
      SELECT COALESCE(MAX(ID), 0) + 1 FROM PERSON
    <span class="xml&#45;tag">&#60;/selectKey&#62;</span>
    INSERT INTO PERSON (ID, VERSION, FIRST_NAME, LAST_NAME, AGE)
    VALUES (&#35;&#123;id&#125;, &#35;&#123;version&#125;, &#35;&#123;firstName&#125;, &#35;&#123;lastName&#125;, &#35;&#123;age&#125;)
  <span class="xml&#45;tag">&#60;/insert&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;update id=<span class="xml&#45;quote">"updatePerson"</span> parameterType=<span class="xml&#45;quote">"org.grails.mybatis.example.Person"</span>&#62;</span>
    UPDATE PERSON
    SET VERSION = &#35;&#123;version&#125;, FIRST_NAME = &#35;&#123;firstName&#125;, LAST_NAME = &#35;&#123;lastName&#125;, AGE = &#35;&#123;age&#125;
    WHERE ID = &#35;&#123;id&#125;
  <span class="xml&#45;tag">&#60;/update&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;/mapper&#62;</span></pre></div><p class="paragraph"/>Now we can modify PersonGatewayTests<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.grails.mybatis.example<p class="paragraph"/><span class="java&#45;keyword">import</span> groovy.sql.Sql<p class="paragraph"/>class PersonGatewayTests <span class="java&#45;keyword">extends</span> GroovyTestCase &#123;<p class="paragraph"/>  /&#42;&#42;
   &#42; Dependency injection is used to test Gateway artefacts
   &#42;/
  def dataSource
  def personGateway<p class="paragraph"/>  <span class="java&#45;keyword">protected</span> void setUp() <span class="java&#45;keyword">throws</span> Exception &#123;
    def sql = <span class="java&#45;keyword">new</span> Sql(dataSource)
    sql.execute(<span class="java&#45;quote">""</span><span class="java&#45;quote">"CREATE TABLE PERSON (
    ID INTEGER NOT NULL,
    VERSION INTEGER NOT NULL,
    FIRST_NAME VARCHAR(30),
    LAST_NAME VARCHAR(30),
    AGE INTEGER,
    PRIMARY KEY (ID)
    )"</span><span class="java&#45;quote">""</span>)
  &#125;<p class="paragraph"/>  <span class="java&#45;keyword">protected</span> void tearDown() <span class="java&#45;keyword">throws</span> Exception &#123;
    def sql = <span class="java&#45;keyword">new</span> Sql(dataSource)
    sql.execute(<span class="java&#45;quote">""</span><span class="java&#45;quote">"DROP TABLE IF EXISTS PERSON"</span><span class="java&#45;quote">""</span>)
  &#125;<p class="paragraph"/>  void testDependencies() &#123;
    assert dataSource
    assert personGateway
  &#125;<p class="paragraph"/>  void testPersonInsert() &#123;
    Person data = <span class="java&#45;keyword">new</span> Person(firstName: 'John', lastName: 'Doe', age: 50)<p class="paragraph"/>    personGateway.insertPerson(data);<p class="paragraph"/>    def databaseData = <span class="java&#45;keyword">new</span> Sql(dataSource).firstRow(<span class="java&#45;quote">"SELECT &#42; FROM PERSON"</span>)<p class="paragraph"/>    assert databaseData&#91;<span class="java&#45;quote">"ID"</span>&#93; == 1
    assert databaseData&#91;<span class="java&#45;quote">"VERSION"</span>&#93; == 1
    assert databaseData&#91;<span class="java&#45;quote">"FIRST_NAME"</span>&#93; == 'John'
    assert databaseData&#91;<span class="java&#45;quote">"LAST_NAME"</span>&#93; == 'Doe'
    assert databaseData&#91;<span class="java&#45;quote">"AGE"</span>&#93; == 50<p class="paragraph"/>    assert data.id == 1
    assert data.version == 1
  &#125;<p class="paragraph"/>  void testLoadPersonById() &#123;
    Person data = <span class="java&#45;keyword">new</span> Person(firstName: 'John', lastName: 'Doe', age: 50)<p class="paragraph"/>    personGateway.insertPerson(data);<p class="paragraph"/>    Person fromDb = personGateway.loadPersonById(data.id)<p class="paragraph"/>    assert fromDb
    assert fromDb.id == data.id
    assert fromDb.version == data.version
    assert fromDb.firstName == data.firstName
  &#125;<p class="paragraph"/>  void testPersonUpdate() &#123;
    Person data = <span class="java&#45;keyword">new</span> Person(firstName: 'John', lastName: 'Doe', age: 50)<p class="paragraph"/>    personGateway.insertPerson(data);<p class="paragraph"/>    assert data.version == 1
    assert data.age == 50<p class="paragraph"/>    Person fromDb = personGateway.loadPersonById(data.id)<p class="paragraph"/>    assert fromDb.id == 1
    assert fromDb.version == 1
    assert fromDb.age == 50<p class="paragraph"/>    data.age = 33<p class="paragraph"/>    personGateway.updatePerson(data)<p class="paragraph"/>    assert data.version == 2
    assert data.age == 33<p class="paragraph"/>    fromDb = personGateway.loadPersonById(data.id)<p class="paragraph"/>    assert fromDb.version == 2
    assert fromDb.age == 33<p class="paragraph"/>    <span class="java&#45;keyword">new</span> Sql(dataSource).execute(<span class="java&#45;quote">"UPDATE PERSON SET VERSION = 7, AGE = 29 WHERE ID = 1"</span>)<p class="paragraph"/>    shouldFail &#123;
      data.firstName = 'Mark'
      personGateway.updatePerson(data)
    &#125;<p class="paragraph"/>  &#125;<p class="paragraph"/>  void testLoadAllPersonList() &#123;
    personGateway.insertPerson(<span class="java&#45;keyword">new</span> Person(firstName: 'John', lastName: 'Doe', age: 20))
    personGateway.insertPerson(<span class="java&#45;keyword">new</span> Person(firstName: 'Mark', lastName: 'Miles', age: 23))<p class="paragraph"/>    def results = personGateway.loadAllPersonList()<p class="paragraph"/>    assert results
    assert results.size() == 2
    assert results&#91;0&#93; <span class="java&#45;keyword">instanceof</span> Person
    assert results&#91;0&#93;.firstName == 'John'
    assert results&#91;1&#93;.firstName == 'Mark'
  &#125;<p class="paragraph"/>&#125;</pre></div>



<h1 id="5 Multivendor database support">5 Multivendor database support</h1>
<h1>Support multiple database vendors</h1><p class="paragraph"/><h2>Configuration</h2><p class="paragraph"/>Add following to your configuration if you want to support H2, Microsoft SQL and IBM Informix databases<p class="paragraph"/><div class="code"><pre>mybatis.multivendor.enabled = <span class="java&#45;keyword">true</span><p class="paragraph"/>mybatis.multivendor.mapping = &#91;
    'Microsoft SQL Server': 'mssql',
    'H2': 'h2',
    'Informix Dynamic Server': 'informix'
&#93;</pre></div><p class="paragraph"/><h2>Mapper support</h2><p class="paragraph"/>Let's say you want to query a databse for persons full name. You have to concat two fields in legacy PERSON table, here is sample mapper to do just that.<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;?xml version=<span class="xml&#45;quote">"1.0"</span> encoding=<span class="xml&#45;quote">"UTF&#45;8"</span> ?&#62;</span>
&#60;!DOCTYPE mapper PUBLIC <span class="xml&#45;quote">"&#45;//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="xml&#45;quote">"http://mybatis.org/dtd/mybatis&#45;3&#45;mapper.dtd"</span>&#62;
<span class="xml&#45;tag">&#60;mapper namespace=<span class="xml&#45;quote">"org.grails.mybatis.example.person"</span>&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;sql id=<span class="xml&#45;quote">"fullNameDatabaseSpecificQuery"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;choose&#62;</span>
      <span class="xml&#45;tag">&#60;when test=<span class="xml&#45;quote">"_databaseId == 'mssql'"</span>&#62;</span>FIRST_NAME + ' ' + LAST_NAME<span class="xml&#45;tag">&#60;/when&#62;</span>
      <span class="xml&#45;tag">&#60;when test=<span class="xml&#45;quote">"_databaseId == 'informix'"</span>&#62;</span>FIRST_NAME || ' ' || LAST_NAME<span class="xml&#45;tag">&#60;/when&#62;</span>
      <span class="xml&#45;tag">&#60;otherwise&#62;</span>CONCAT(FIRST_NAME, ' ', LAST_NAME<span class="xml&#45;tag">&#60;/otherwise&#62;</span>
    <span class="xml&#45;tag">&#60;/choose&#62;</span>
  <span class="xml&#45;tag">&#60;/sql&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;select id=<span class="xml&#45;quote">"loadPersonFullNameById&#62;</span>"</span> resultType=<span class="xml&#45;quote">"String"</span> parameterType=<span class="xml&#45;quote">"Integer"</span>&#62;
    SELECT <span class="xml&#45;tag">&#60;include refid=<span class="xml&#45;quote">"fullNameDatabaseSpecificQuery"</span>/&#62;</span>
    FROM PERSON
    WHERE ID = &#35;&#123;value&#125;
  <span class="xml&#45;tag">&#60;/select&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;/mapper&#62;</span></pre></div>



<h1 id="6 Custom TypeHandlers">6 Custom TypeHandlers</h1>
<h1>Writing custom MyBatis TypeHandlers</h1><p class="paragraph"/><h2>What are TypeHandlers</h2>
Type handlers are used for data transformation. For example, you are connecting to a legacy database that stores list of data in a single VARCHAR field, and each item is enclosed with brackets. You have to extract that data, and you can do it with a custom type handler.<p class="paragraph"/><h2>Writing a TypeHandler</h2>
TypeHandlers are artefact classes which should be placed in grails-app/typeHandlers and end with "TypeHandler"<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.grails.mybatis.example<p class="paragraph"/><span class="java&#45;keyword">import</span> java.sql.CallableStatement
<span class="java&#45;keyword">import</span> java.sql.PreparedStatement
<span class="java&#45;keyword">import</span> java.sql.ResultSet
<span class="java&#45;keyword">import</span> java.sql.SQLException<p class="paragraph"/><span class="java&#45;keyword">import</span> org.apache.ibatis.type.BaseTypeHandler
<span class="java&#45;keyword">import</span> org.apache.ibatis.type.JdbcType
<span class="java&#45;keyword">import</span> org.apache.ibatis.type.MappedJdbcTypes
<span class="java&#45;keyword">import</span> org.apache.ibatis.type.MappedTypes<p class="paragraph"/>@MappedJdbcTypes(JdbcType.VARCHAR)
@MappedTypes(&#91;List&#93;)
class ExampleTypeHandler <span class="java&#45;keyword">extends</span> BaseTypeHandler&#60;List&#60;<span class="java&#45;object">String</span>&#62;&#62;&#123;
  def <span class="java&#45;keyword">static</span> dataSourceName = 'dataSource'<p class="paragraph"/>  @Override
  <span class="java&#45;keyword">public</span> void setNonNullParameter(PreparedStatement statement, <span class="java&#45;object">int</span> index, List&#60;<span class="java&#45;object">String</span>&#62; parameter, JdbcType jdbcType) <span class="java&#45;keyword">throws</span> SQLException &#123;
    def builder = <span class="java&#45;quote">""</span> as StringBuilder<p class="paragraph"/>    parameter.each &#123;
      builder += <span class="java&#45;quote">"&#91;$it&#93;"</span>
    &#125;<p class="paragraph"/>    statement.setString(index, builder.toString())
  &#125;<p class="paragraph"/>  List&#60;<span class="java&#45;object">String</span>&#62; decodeValue(<span class="java&#45;object">String</span> value) &#123;
    def matcher = value =~ /&#91;(.&#42;?)&#93;/
    def results = &#91;&#93;<p class="paragraph"/>    matcher.each &#123;
      results &#60;&#60; it&#91;1&#93;
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">return</span> results
  &#125;<p class="paragraph"/>  @Override
  <span class="java&#45;keyword">public</span> List&#60;<span class="java&#45;object">String</span>&#62; getNullableResult(ResultSet resultSet, <span class="java&#45;object">String</span> columnName) <span class="java&#45;keyword">throws</span> SQLException &#123;
    def encoded = resultSet.getString(columnName)
    <span class="java&#45;keyword">return</span> decodeValue(encoded)
  &#125;<p class="paragraph"/>  @Override
  <span class="java&#45;keyword">public</span> List&#60;<span class="java&#45;object">String</span>&#62; getNullableResult(ResultSet resultSet, <span class="java&#45;object">int</span> columnIndex) &#123;
    def encoded = resultSet.getString(columnIndex)
    <span class="java&#45;keyword">return</span> decodeValue(encoded)
  &#125;<p class="paragraph"/>  @Override
  <span class="java&#45;keyword">public</span> List&#60;<span class="java&#45;object">String</span>&#62; getNullableResult(CallableStatement statement, <span class="java&#45;object">int</span> columnIndex) <span class="java&#45;keyword">throws</span> SQLException &#123;
    def encoded = statement.getString(columnIndex)
    <span class="java&#45;keyword">return</span> decodeValue(encoded)
  &#125;
&#125;</pre></div><p class="paragraph"/>You have to register that type handler to a specific MyBatis result using typeHanlder attribute in mapper file.<p class="paragraph"/><h2>Custom Enum type handlers</h2>
From time to time old databases store some enumerated information in a specific way (single character). If you need to map such values to your enums it can be done by extending AbstractEnumTypeHandler class provided in this plugin<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.grails.plugins.mybatis.enums<p class="paragraph"/>enum SampleEnum &#123;
  VALUE_ONE('O'), VALUE_TWO('T')<p class="paragraph"/>  <span class="java&#45;object">String</span> dbCode<p class="paragraph"/>  SampleEnum(dbCode)&#123;
    <span class="java&#45;keyword">this</span>.dbCode = dbCode
  &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.grails.plugins.mybatis.enums<p class="paragraph"/>class SampleEnumTypeHandler <span class="java&#45;keyword">extends</span> AbstractEnumTypeHandler&#60;SampleEnum&#62; &#123;
  SampleEnumTypeHandler() &#123;
    <span class="java&#45;keyword">super</span>(SampleEnum, <span class="java&#45;quote">"dbCode"</span>)
  &#125;
&#125;</pre></div>


                    </div>
                </td>
                <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Samples</h1><div class="menu-sub">
                        
                        
                        <div class="menu-item"><a href="../ref/Samples/Gateway.html">Gateway</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Samples/Mapper%20XML.html">Mapper XML</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Samples/MyBatisDomainClass.html">MyBatisDomainClass</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Samples/TypeHandlers.html">TypeHandlers</a>
                        </div>
                        
                        </div>
                    </div>
                    
                </div>
            </div>
        </td>
            </tr>
        </table>

        <div id="footer">
            
            
        </div>



<script type="text/javascript" src="../js/docs.js"></script>

    </body>
</html>
